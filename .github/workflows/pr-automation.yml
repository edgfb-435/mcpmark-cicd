name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        run: |
          npm run lint > eslint-results.txt 2>&1 || true
          echo "eslint_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Run Prettier check
        id: prettier
        run: |
          npx prettier --check . > prettier-results.txt 2>&1 || true
          echo "prettier_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Post Code Quality Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const eslintResults = fs.readFileSync('eslint-results.txt', 'utf8');
            const prettierResults = fs.readFileSync('prettier-results.txt', 'utf8');
            const eslintExitCode = ${{ steps.eslint.outputs.eslint_exit_code }};
            const prettierExitCode = ${{ steps.prettier.outputs.prettier_exit_code }};
            
            let comment = "## Code Quality Report\n\n";
            comment += "### ESLint Results:\n";
            comment += eslintExitCode === 0 ? "✅ No ESLint errors found.\n" : "❌ ESLint errors found:\n```\n" + eslintResults + "\n```\n";
            comment += "\n### Prettier Results:\n";
            comment += prettierExitCode === 0 ? "✅ All files are properly formatted.\n" : "❌ Formatting issues found:\n```\n" + prettierResults + "\n```\n";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  testing-suite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests and generate coverage
        run: npm test -- --coverage

      - name: Post Test Coverage Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageReport = fs.readFileSync('coverage/coverage-summary.json', 'utf8');
            const coverage = JSON.parse(coverageReport);
            
            let comment = "## Test Coverage Report\n\n";
            comment += `**Total Lines Covered:** ${coverage.total.lines.pct}%\n`;
            comment += `**Total Functions Covered:** ${coverage.total.functions.pct}%\n`;
            comment += `**Total Branches Covered:** ${coverage.total.branches.pct}%\n`;
            comment += `**Total Statements Covered:** ${coverage.total.statements.pct}%\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run dependency vulnerability check
        id: dep-check
        run: |
          npm audit > npm-audit-results.txt 2>&1 || true
          echo "dep_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Scan for secrets
        id: secret-scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          format: json
          out-file: trufflehog-results.json

      - name: Post Security Scan Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const depResults = fs.readFileSync('npm-audit-results.txt', 'utf8');
            const secretResults = fs.readFileSync('trufflehog-results.json', 'utf8');
            const depExitCode = ${{ steps.dep-check.outputs.dep_exit_code }};
            
            let comment = "## Security Scan Report\n\n";
            comment += "### Dependencies Vulnerabilities:\n";
            comment += depExitCode === 0 ? "✅ No critical vulnerabilities found.\n" : "❌ Vulnerabilities found:\n```\n" + depResults + "\n```\n";
            comment += "\n### Secrets Scan Results:\n";
            const secrets = JSON.parse(secretResults);
            if (secrets.length === 0) {
              comment += "✅ No secrets detected in code changes.\n";
            } else {
              comment += "❌ Secrets found:\n```json\n" + JSON.stringify(secrets, null, 2) + "\n```\n";
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

  build-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        id: build
        run: |
          npm run build > build-results.txt 2>&1 || true
          echo "build_exit_code=$?" >> $GITHUB_OUTPUT

      - name: Validate endpoints
        id: validate-endpoints
        run: |
          # Start app in background
          npm start &
          APP_PID=$!
          
          # Wait for app to initialize
          sleep 15
          
          # Test health endpoint (adjust if your app uses different endpoints)
          curl -f http://localhost:3000/health > endpoints-results.txt 2>&1 || true
          ENDPOINT_EXIT_CODE=$?
          
          # Cleanup: stop the app
          kill $APP_PID || true
          
          echo "endpoint_exit_code=$ENDPOINT_EXIT_CODE" >> $GITHUB_OUTPUT

      - name: Upload deployment preview artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-preview
          path: |
            build/
            dist/

      - name: Post Build Validation Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const buildResults = fs.readFileSync('build-results.txt', 'utf8');
            const endpointResults = fs.readFileSync('endpoints-results.txt', 'utf8');
            const buildExitCode = ${{ steps.build.outputs.build_exit_code }};
            const endpointExitCode = ${{ steps.validate-endpoints.outputs.endpoint_exit_code }};
            
            let comment = "## Build Validation\n\n";
            comment += "### Build Status:\n";
            comment += buildExitCode === 0 ? "✅ Build succeeded.\n" : "❌ Build failed:\n```\n" + buildResults + "\n```\n";
            comment += "\n### Endpoint Validation:\n";
            comment += endpointExitCode === 0 ? "✅ All endpoints are accessible.\n" : "❌ Endpoint validation failed:\n```\n" + endpointResults + "\n```\n";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });